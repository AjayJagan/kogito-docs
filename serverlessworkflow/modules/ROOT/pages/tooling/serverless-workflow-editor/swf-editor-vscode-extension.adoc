= VScode Extension for the Kogito Serverless Workflow Editor

The VScode extension for the Kogito Serverless Workflow Editor allows you to view and edit link:{spec_website_url}[CNCF Serverless Workflow Specification] files in your local projects.

.Prerequisites
* Visual Studio Code version {vscode_version} and above.

.Kogito Serverless Workflow VScode Extension
image::tooling/serverless-workflow-editor/swf-editor-vscode-extension-page.png[]

== Installing the VScode Extension

The VScode extension can be installed in two ways.

* You can visit link:{kogito_swf_editor_vscode_marketplace_url}[Kogito Serverless Workflow Editor] and follow the instructions or use the *extensions* tab(Ctrl+Shift+X) and click on *install* to install the extension.

.Installing VScode Extension in marketplace
image::tooling/serverless-workflow-editor/swf-editor-vscode-market-place.png[]

* You can download the 'vscode_extension_serverless_workflow_editor_VERSION.vsix' link:{kie_tools_releases_page_url}[kie-tools] and install it in vscode using the *Install from VSIX* option in the extensions menu.

.Installing VScode Extension using vsix
image::tooling/serverless-workflow-editor/swf-editor-vscode-vsix-package.png[]

== Working with the VScode Extension

Once installation is complete, you can create a Serverless Workflow file or open an existing file in VScode. VScode will automatically use the extension when you open a Serverless Workflow file.

The extension provides a set of commands to perform specific actions.

=== List of commands
* *Serverless Workflow: Generate SVG without any notification*: Generates an SVG file of the diagram in the workspace next to the Serverless Workflow file.
* *Serverless Workflow: Open as Diagram (to the side)*: Opens the diagram to the right side of the editor
* *Serverless Workflow: Setup automatically open Diagram Editor alongside Text Editor*: Allows the user to configure if the diagram should be opened by default alongside the editor. Provides two options, *Open automatically* and *Do not open*.
* *Serverless Workflow: Configure Service Registries*: Opens the configuration for the Service Registries in the Extension Settings screen.
* *Serverless Workflow: Refresh Service Registries*: Refresh the artifact list of the Service Registries.
* *Serverless Workflow: Log in Service Registries*: Triggers a log in action of the Service Registries.

To trigger a command, go to *view* → *Command Palette*... or press *Ctrl+Shift+P* to open the command palette. Type in *Serverless Workflow* in the search bar to see the list of commands.

.Command palette of the VScode extension
image::tooling/serverless-workflow-editor/swf-editor-vscode-command-palette.png[]

=== Kogito Serverless Workflow Editor Setttings
The extension's settings can be configured by navigating to *File* → *Preferences* → *Settings*.

.The following settings can be configured in the settings page:
* *Automatically Open Diagram Editor Alongside Text Editor*: Sets if the diagram should be opened by default when a Serverless Workflow is edited. The possible options are: *Ask next time*(default), *Do not open* and *Open automatically*.
* *Run On Save*: Sets the VScode command to execute when saving the edited Serverless Workflow file, defaults 'extension.kogito.swf.silentlyGenerateSvg' (generate the diagram SVG).
* *Service Registries*: Gives access to the Service Registries configuration in the _settings.json_ file.
* *Should Reference Service Registry Functions With Urls*: when autocompleting functions from link:{open_api_spec_url}[OpenAPI spec] files in the Service Registry, this setting specifies if the Function operation should use the URL to the link:{open_api_spec_url}[OpenAPI spec] file or use a local path (file will be downloaded to the *Specs Storage Path*).
* *Specs Storage Path*: Provides a text box to edit the path oflink:{open_api_spec_url}[OpenAPI spec] file (defaults to 'specs' folder next to the edited Serverless Workflow file).
* *Svg Filename Template*: Sets the filename template to be used when generating the diagram SVG file. Defaults to 'fileName.svg'.
* *Svg File Path*: Sets he path to store the diagram SVG. Defaults to the same edited Serverless Workflow directory.

.Settings page of the extension
image::tooling/serverless-workflow-editor/swf-editor-vscode-settings.png[]

=== Context based auto-completion
The extension can use link:{open_api_spec_url}[OpenAPI spec] files stored locally in the 'specs folder' (<<Kogito Serverless Workflow Editor Setttings,check the settings section>>) or in remote Service Registries to provide advanced auto-complete features for *Function Definitions*.

The extension is able to parse the link:{open_api_spec_url}[OpenAPI spec] files and provide the list of Function Definitions in the auto-complete dialog.

.Function Definition auto complete dialogue
image::tooling/serverless-workflow-editor/swf-editor-function-definition-auto-complete-dialogue.png[]

After selecting one of the options in the auto-complete dialog, a full Function Definition object will be added to the functions array with the right settings.

.Function Definition object auto completed
image::tooling/serverless-workflow-editor/swf-editor-auto-completed-function-definition.png[]

Once function definition is added, it will be available for auto completion in the Function Reference section.

.Function Reference auto complete dialogue
image::tooling/serverless-workflow-editor/swf-editor-auto-complete-function-reference-dialogue.png[]

After selecting one of the options in the auto-complete dialog, a full Function Reference object will be added with the right reference name and attributes.

.Function Reference object auto completed
image::tooling/serverless-workflow-editor/swf-editor-auto-completed-function-reference.png[]

== How to enable the extension to load OpenAPI files from Apicurio Registries

=== Configuring the Service Registry
The extension allows to configure a list of Service Registries that will enable the editor to load link:{open_api_spec_url}[OpenAPI spec] files stored in the external registries.

You can add the list of Service Registries in the extension's _settings.json_ file using the _kogito.swf.serviceRegistries_ key that matches the following JSON schema.

.Service Registry Schema:

[source,json]
----
 {
  "type": "object",
  "properties": {
    "registries": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "name": { "type": "string" },
          "url": {
            "type": "string",
            "format": "uri",
            "pattern": "^https?://?[-A-Za-z0-9+&@#/%?=_!:.]+[-A-Za-z0-9+&@#/%=~_|]"
          },
          "authProvider": {
            "type": "string",
            "enum": ["none", "red-hat-account", "oidc"],
            "default": "none"
          },
          "authUrl": {
            "type": "string",
            "format": "uri",
            "pattern": "^https?://?[-A-Za-z0-9+&@#/%?=_!:.]+[-A-Za-z0-9+&@#/%=~_|]"
          },
          "clientId": { "type": "string" }
        },
        "allOf": [
          {
            "if": {
              "properties": {
                "authProvider": { "const": "oidc" }
              }
            },
            "then": {
              "required": ["authUrl", "clientId"]
            }
          }
        ],
        "required": ["name", "url", "authProvider"]
      }
    }
  }
}
----

.Each item in the *registries* array should have atleast the following three properties:
* *name*: The identifier provided for the particular registry.
* *url*: The URL for the REST api of the Apicurio Registry.
* *authProvider*: The type of authentication for the Apicurio Registry. The expected values are *none* (no authentication) and *red-hat-account* (login with your Red Hat account).

.Example of Service Registry Configuration:
[source,json]
----
{
    "kogito.swf.serviceRegistries": {
        "registries": [
            {
                "name": "openshift",
                "url": "https://{url-to-openshift-registry}/apis/registry/v2",
                "authProvider": "red-hat-account"
            },
            {
                "name": "local",
                "url": "https://{url-to-local-registry}/apis/registry/v2",
                "authProvider": "none"
            },
        ]
    }
}
----

[NOTE] 
====
The Service Registry settings are available on the extension settings and they could be accessed by clicking on the *Setup Service Registries*... situated above the Function Definition section or using the command *Serverless Workflow: Configure Service Registries*.
====

=== Using the Service Registries for auto-completion

.If you have a Service Registry that requires Red Hat authentication the following are the prereqisites:
* A link:{red_hat_sso_login_url}[Red Hat account] with access to link:{red_hat_hybrid_cloud_console_url}[Red Hat Hybrid Cloud Console].
* link:{red_hat_auth_vscode_marketplace_url}[Redhat authentication extension]

In the Serverless Workflow file, you can see that there is an option to *Setup Service Registries*. Click on it to get navigated to the _settings.json_ file to configure the *registries*.

.Function Definition Section with Setup Service Registries option
image::tooling/serverless-workflow-editor/swf-editor-vscode-setup-registry.png[]

Once you configure the Service Registry settings, the Function Definition section of the workflow file shows a *Log in Service Registries* button if it is configured to a remote Service Registry (Eg. Apicurio Registry). Clicking on this button redirects to the Red Hat login (SSO) page. You can login with your Red Hat credentials to connect to the Apicurio Registries.

[NOTE] 
====
The redirection to Red Hat login (SSO) page happens only if the *authProvider* has the value of 'red-hat-account' in the Service Registry settings.
====

.Function Definition Section with Log in Service Registries option
image::tooling/serverless-workflow-editor/swf-editor-login-service-registries-function-definition.png[]

Once you have successfully logged in, use *Ctrl+Space* in the workflow's Function Definitions section to view the list of functions available.

.Function workflow definition section auto-complete
image::tooling/serverless-workflow-editor/swf-editor-auto-complete-dialog.png[]

Click on the required function to auto-complete the Function Definition.

.Auto-completed Function Definition
image::tooling/serverless-workflow-editor/swf-editor-completed-function-definition.png[]

[NOTE]
====
After selecting one of the options in the auto-complete dialog, the link:{open_api_spec_url}[OpenAPI spec] file will be downloaded into the 'specs' folder(<<Kogito Serverless Workflow Editor Setttings,Configured in the settings>>). The saved file follows the format of _REGISTRY-NAME_OPERATION-NAME_VERSION_.
====

.Downloaded OpenAPI spec file
image::tooling/serverless-workflow-editor/swf-editor-open-api-spec.png[]

If any change is made in the registry, make use of the *Refresh Service Registries*... to fetch the new changes.

.Refresh Service Registries button in Function Definition section
image::tooling/serverless-workflow-editor/swf-editor-refresh-registry.png[]

Click on the *Add function*... button to create a new Function Definition object.

Now you have successfully connected to the Apicurio Registry and made use of the auto-complete feature of the extension.

== Validation

[NOTE]
====
Currently validation is performed only for JSON files. The validation is based on JSON schema, and it checks only the structure of the JSON and not the content.
====

The validation warnings and errors can be seen in the *Problems* tab. Go to *View* → *Problems* or press *Ctrl+Shift+M* to open the *Problems* tab.

.Errors and warnings in problems tab
image::tooling/serverless-workflow-editor/swf-editor-vscode-problems-tab.png[]

include::../../../pages/_common-content/report-issue.adoc[]